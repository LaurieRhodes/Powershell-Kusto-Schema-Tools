# DCR from Log Analytics

Production-ready Data Collection Rule (DCR) Bicep templates generated from live Log Analytics workspace schemas. Each subdirectory contains deployment-ready Infrastructure as Code for ingesting data into Microsoft native tables with hybrid schema discovery.

## ## File Structure

Each subdirectory contains three files:

### DCR Bicep Template (`dcr-{tablename}.bicep`)

- **Resource Type**: `Microsoft.Insights/dataCollectionRules@2022-06-01`
- **Schema Source**: Hybrid discovery (Management API + getschema runtime queries)
- **Output Stream**: `Microsoft-{TableName}` for native tables
- **Transform KQL**: Automated type conversion from string input to target schema
- **Role Assignment**: Service principal permissions for data ingestion

### Parameters File (`dcr-{tablename}.parameters.json`)

- **Data Collection Endpoint**: DCE resource ID for secure ingestion
- **Workspace Configuration**: Target Log Analytics workspace settings
- **Service Principal**: Object ID for authentication and permissions
- **Location**: Deployment region (default: Australia East)

### Deployment Script (`deploy-{tablename}.ps1`)

- **PowerShell Automation**: Simplified deployment with timestamped naming
- **Parameter Validation**: Required resource group with optional parameters file
- **Verbose Output**: Detailed deployment progress and error reporting

### Authentication & Permissions

- **Role Assignment**: Monitoring Metrics Publisher role (3913510d-42f4-4e42-8a64-420c390055eb)
- **Service Principal**: Automated permission assignment to DCR resource
- **Secure Ingestion**: Data Collection Endpoint integration for private networking

## Key Differences from JSON-based DCRs

### Schema Source

- **Live Discovery**: Schemas extracted from active Log Analytics workspaces
- **Runtime Validation**: Uses getschema queries for actual column types
- **Production Accuracy**: Reflects current workspace table structures - preferred over Sentinel Archive JSON artifacts for accuracy.

### Output Streams

- **Microsoft Native**: Output streams may includeMicrosoft-{TableName}` formatas well as Custom Logs.  Note that not all Microsoft Log Analytics tables are writable.
  
  

## Deployment

### Prerequisites

- Data Collection Endpoint (DCE)
- Log Analytics Workspace with target tables
- Service Principal with appropriate permissions
- Az.Resources and Az.Monitor PowerShell modules

### Quick Deploy

```powershell
.\deploy-{tablename}.ps1 -ResourceGroupName "your-rg"
```

### Parameter Customization

Update parameters file with actual resource IDs:

```json
{
  "dataCollectionEndpointId": { "value": "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Insights/dataCollectionEndpoints/{dce}" },
  "workspaceResourceId": { "value": "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.OperationalInsights/workspaces/{workspace}" },
  "servicePrincipalObjectId": { "value": "{sp-object-id}" }
}
```

# 

## Source Generation

Generated by `log-analytics-to-bicep-dcr-export.ps1` using hybrid schema discovery (Management API + getschema) from live Log Analytics workspaces.