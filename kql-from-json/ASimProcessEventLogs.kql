// ============================================================================
// Azure Data Explorer KQL Script for ASimProcessEventLogs
// ============================================================================
// Generated: 2025-09-13 20:17:11
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table ASimProcessEventLogsRaw (records:dynamic)

.alter-merge table ASimProcessEventLogsRaw policy retention softdelete = 1d

.alter table ASimProcessEventLogsRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table ASimProcessEventLogsRaw ingestion json mapping 'ASimProcessEventLogsRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table ASimProcessEventLogs(
TimeGenerated:datetime,
TenantId:guid,
TargetProcessName:string,
TargetProcessCommandLine:string,
ParentProcessTokenElevation:string,
ParentProcessCreationTime:datetime,
ParentProcessIMPHASH:string,
ParentProcessSHA512:string,
ParentProcessSHA256:string,
ParentProcessSHA1:string,
ParentProcessMD5:string,
ParentProcessIntegrityLevel:string,
ParentProcessGuid:string,
ParentProcessId:string,
ParentProcessInjectedAddress:string,
ParentProcessIsHidden:bool,
TargetProcessFileCompany:string,
ParentProcessFileVersion:string,
ParentProcessFileDescription:string,
ParentProcessFileCompany:string,
ParentProcessName:string,
ActingProcessFileSize:long,
ActingProcessTokenElevation:string,
ActingProcessCreationTime:datetime,
ActingProcessIMPHASH:string,
ActingProcessSHA512:string,
ActingProcessSHA256:string,
ActingProcessSHA1:string,
ActingProcessMD5:string,
ActingProcessIntegrityLevel:string,
ActingProcessGuid:string,
ActingProcessId:string,
ParentProcessFileProduct:string,
ActingProcessInjectedAddress:string,
TargetProcessFileDescription:string,
TargetProcessFileVersion:string,
ThreatFirstReportedTime:datetime,
ThreatIsActive:bool,
ThreatOriginalConfidence:string,
ThreatConfidence:int,
ThreatField:string,
ThreatOriginalRiskLevel:string,
ThreatRiskLevel:int,
ThreatCategory:string,
ThreatName:string,
ThreatId:string,
RuleNumber:int,
RuleName:string,
TargetProcessStatusCode:string,
TargetProcessCurrentDirectory:string,
TargetProcessFileProduct:string,
TargetProcessFileSize:long,
TargetProcessCreationTime:datetime,
TargetProcessIMPHASH:string,
TargetProcessSHA512:string,
TargetProcessSHA256:string,
TargetProcessSHA1:string,
TargetProcessMD5:string,
TargetProcessIntegrityLevel:string,
TargetProcessGuid:string,
TargetProcessId:string,
TargetProcessInjectedAddress:string,
TargetProcessIsHidden:bool,
TargetProcessFilename:string,
TargetProcessFileOriginalName:string,
TargetProcessFileInternalName:string,
TargetProcessTokenElevation:string,
ThreatLastReportedTime:datetime,
ActingProcessIsHidden:bool,
ActingProcessFileOriginalName:string,
DvcMacAddr:string,
DvcIdType:string,
DvcId:string,
DvcDescription:string,
DvcFQDN:string,
DvcDomainType:string,
DvcDomain:string,
DvcHostname:string,
DvcIpAddr:string,
EventReportUrl:string,
EventOwner:string,
EventSchemaVersion:string,
EventVendor:string,
EventProductVersion:string,
DvcZone:string,
EventProduct:string,
EventSeverity:string,
EventOriginalResultDetails:string,
EventOriginalSubType:string,
EventOriginalType:string,
EventOriginalUid:string,
EventResultDetails:string,
EventResult:string,
EventSubType:string,
EventType:string,
EventEndTime:datetime,
EventStartTime:datetime,
EventCount:int,
EventMessage:string,
AdditionalFields:dynamic,
EventOriginalSeverity:string,
ActingProcessFilename:string,
DvcOs:string,
DvcAction:string,
ActingProcessFileInternalName:string,
ActingProcessFileVersion:string,
ActingProcessFileProduct:string,
ActingProcessFileDescription:string,
ActingProcessFileCompany:string,
ActingProcessName:string,
ActingProcessCommandLine:string,
TargetUserSessionGuid:string,
TargetUserSessionId:string,
TargetOriginalUserType:string,
TargetUserType:string,
TargetUsernameType:string,
TargetUsername:string,
TargetScope:string,
DvcOsVersion:string,
TargetScopeId:string,
TargetUserId:string,
ActorSessionId:string,
ActorOriginalUserType:string,
ActorUserType:string,
ActorUsernameType:string,
ActorUsername:string,
ActorScope:string,
ActorScopeId:string,
ActorUserIdType:string,
ActorUserId:string,
DvcScope:string,
DvcScopeId:string,
DvcInterface:string,
DvcOriginalAction:string,
TargetUserIdType:string,
SourceSystem:string,
Type:string,
_TimeReceived:datetime)

.alter table ASimProcessEventLogs policy caching hot = 1d

.create-or-alter function ASimProcessEventLogsExpand() {
ASimProcessEventLogsRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
TenantId=toguid(events.TenantId),
TargetProcessName=tostring(events.TargetProcessName),
TargetProcessCommandLine=tostring(events.TargetProcessCommandLine),
ParentProcessTokenElevation=tostring(events.ParentProcessTokenElevation),
ParentProcessCreationTime=todatetime(events.ParentProcessCreationTime),
ParentProcessIMPHASH=tostring(events.ParentProcessIMPHASH),
ParentProcessSHA512=tostring(events.ParentProcessSHA512),
ParentProcessSHA256=tostring(events.ParentProcessSHA256),
ParentProcessSHA1=tostring(events.ParentProcessSHA1),
ParentProcessMD5=tostring(events.ParentProcessMD5),
ParentProcessIntegrityLevel=tostring(events.ParentProcessIntegrityLevel),
ParentProcessGuid=tostring(events.ParentProcessGuid),
ParentProcessId=tostring(events.ParentProcessId),
ParentProcessInjectedAddress=tostring(events.ParentProcessInjectedAddress),
ParentProcessIsHidden=tobool(events.ParentProcessIsHidden),
TargetProcessFileCompany=tostring(events.TargetProcessFileCompany),
ParentProcessFileVersion=tostring(events.ParentProcessFileVersion),
ParentProcessFileDescription=tostring(events.ParentProcessFileDescription),
ParentProcessFileCompany=tostring(events.ParentProcessFileCompany),
ParentProcessName=tostring(events.ParentProcessName),
ActingProcessFileSize=tolong(events.ActingProcessFileSize),
ActingProcessTokenElevation=tostring(events.ActingProcessTokenElevation),
ActingProcessCreationTime=todatetime(events.ActingProcessCreationTime),
ActingProcessIMPHASH=tostring(events.ActingProcessIMPHASH),
ActingProcessSHA512=tostring(events.ActingProcessSHA512),
ActingProcessSHA256=tostring(events.ActingProcessSHA256),
ActingProcessSHA1=tostring(events.ActingProcessSHA1),
ActingProcessMD5=tostring(events.ActingProcessMD5),
ActingProcessIntegrityLevel=tostring(events.ActingProcessIntegrityLevel),
ActingProcessGuid=tostring(events.ActingProcessGuid),
ActingProcessId=tostring(events.ActingProcessId),
ParentProcessFileProduct=tostring(events.ParentProcessFileProduct),
ActingProcessInjectedAddress=tostring(events.ActingProcessInjectedAddress),
TargetProcessFileDescription=tostring(events.TargetProcessFileDescription),
TargetProcessFileVersion=tostring(events.TargetProcessFileVersion),
ThreatFirstReportedTime=todatetime(events.ThreatFirstReportedTime),
ThreatIsActive=tobool(events.ThreatIsActive),
ThreatOriginalConfidence=tostring(events.ThreatOriginalConfidence),
ThreatConfidence=toint(events.ThreatConfidence),
ThreatField=tostring(events.ThreatField),
ThreatOriginalRiskLevel=tostring(events.ThreatOriginalRiskLevel),
ThreatRiskLevel=toint(events.ThreatRiskLevel),
ThreatCategory=tostring(events.ThreatCategory),
ThreatName=tostring(events.ThreatName),
ThreatId=tostring(events.ThreatId),
RuleNumber=toint(events.RuleNumber),
RuleName=tostring(events.RuleName),
TargetProcessStatusCode=tostring(events.TargetProcessStatusCode),
TargetProcessCurrentDirectory=tostring(events.TargetProcessCurrentDirectory),
TargetProcessFileProduct=tostring(events.TargetProcessFileProduct),
TargetProcessFileSize=tolong(events.TargetProcessFileSize),
TargetProcessCreationTime=todatetime(events.TargetProcessCreationTime),
TargetProcessIMPHASH=tostring(events.TargetProcessIMPHASH),
TargetProcessSHA512=tostring(events.TargetProcessSHA512),
TargetProcessSHA256=tostring(events.TargetProcessSHA256),
TargetProcessSHA1=tostring(events.TargetProcessSHA1),
TargetProcessMD5=tostring(events.TargetProcessMD5),
TargetProcessIntegrityLevel=tostring(events.TargetProcessIntegrityLevel),
TargetProcessGuid=tostring(events.TargetProcessGuid),
TargetProcessId=tostring(events.TargetProcessId),
TargetProcessInjectedAddress=tostring(events.TargetProcessInjectedAddress),
TargetProcessIsHidden=tobool(events.TargetProcessIsHidden),
TargetProcessFilename=tostring(events.TargetProcessFilename),
TargetProcessFileOriginalName=tostring(events.TargetProcessFileOriginalName),
TargetProcessFileInternalName=tostring(events.TargetProcessFileInternalName),
TargetProcessTokenElevation=tostring(events.TargetProcessTokenElevation),
ThreatLastReportedTime=todatetime(events.ThreatLastReportedTime),
ActingProcessIsHidden=tobool(events.ActingProcessIsHidden),
ActingProcessFileOriginalName=tostring(events.ActingProcessFileOriginalName),
DvcMacAddr=tostring(events.DvcMacAddr),
DvcIdType=tostring(events.DvcIdType),
DvcId=tostring(events.DvcId),
DvcDescription=tostring(events.DvcDescription),
DvcFQDN=tostring(events.DvcFQDN),
DvcDomainType=tostring(events.DvcDomainType),
DvcDomain=tostring(events.DvcDomain),
DvcHostname=tostring(events.DvcHostname),
DvcIpAddr=tostring(events.DvcIpAddr),
EventReportUrl=tostring(events.EventReportUrl),
EventOwner=tostring(events.EventOwner),
EventSchemaVersion=tostring(events.EventSchemaVersion),
EventVendor=tostring(events.EventVendor),
EventProductVersion=tostring(events.EventProductVersion),
DvcZone=tostring(events.DvcZone),
EventProduct=tostring(events.EventProduct),
EventSeverity=tostring(events.EventSeverity),
EventOriginalResultDetails=tostring(events.EventOriginalResultDetails),
EventOriginalSubType=tostring(events.EventOriginalSubType),
EventOriginalType=tostring(events.EventOriginalType),
EventOriginalUid=tostring(events.EventOriginalUid),
EventResultDetails=tostring(events.EventResultDetails),
EventResult=tostring(events.EventResult),
EventSubType=tostring(events.EventSubType),
EventType=tostring(events.EventType),
EventEndTime=todatetime(events.EventEndTime),
EventStartTime=todatetime(events.EventStartTime),
EventCount=toint(events.EventCount),
EventMessage=tostring(events.EventMessage),
AdditionalFields=todynamic(events.AdditionalFields),
EventOriginalSeverity=tostring(events.EventOriginalSeverity),
ActingProcessFilename=tostring(events.ActingProcessFilename),
DvcOs=tostring(events.DvcOs),
DvcAction=tostring(events.DvcAction),
ActingProcessFileInternalName=tostring(events.ActingProcessFileInternalName),
ActingProcessFileVersion=tostring(events.ActingProcessFileVersion),
ActingProcessFileProduct=tostring(events.ActingProcessFileProduct),
ActingProcessFileDescription=tostring(events.ActingProcessFileDescription),
ActingProcessFileCompany=tostring(events.ActingProcessFileCompany),
ActingProcessName=tostring(events.ActingProcessName),
ActingProcessCommandLine=tostring(events.ActingProcessCommandLine),
TargetUserSessionGuid=tostring(events.TargetUserSessionGuid),
TargetUserSessionId=tostring(events.TargetUserSessionId),
TargetOriginalUserType=tostring(events.TargetOriginalUserType),
TargetUserType=tostring(events.TargetUserType),
TargetUsernameType=tostring(events.TargetUsernameType),
TargetUsername=tostring(events.TargetUsername),
TargetScope=tostring(events.TargetScope),
DvcOsVersion=tostring(events.DvcOsVersion),
TargetScopeId=tostring(events.TargetScopeId),
TargetUserId=tostring(events.TargetUserId),
ActorSessionId=tostring(events.ActorSessionId),
ActorOriginalUserType=tostring(events.ActorOriginalUserType),
ActorUserType=tostring(events.ActorUserType),
ActorUsernameType=tostring(events.ActorUsernameType),
ActorUsername=tostring(events.ActorUsername),
ActorScope=tostring(events.ActorScope),
ActorScopeId=tostring(events.ActorScopeId),
ActorUserIdType=tostring(events.ActorUserIdType),
ActorUserId=tostring(events.ActorUserId),
DvcScope=tostring(events.DvcScope),
DvcScopeId=tostring(events.DvcScopeId),
DvcInterface=tostring(events.DvcInterface),
DvcOriginalAction=tostring(events.DvcOriginalAction),
TargetUserIdType=tostring(events.TargetUserIdType),
SourceSystem=tostring(events.SourceSystem),
Type=tostring(events.Type),
_TimeReceived=todatetime(now())
}

.alter table ASimProcessEventLogs policy update @'[{"Source": "ASimProcessEventLogsRaw", "Query": "ASimProcessEventLogsExpand()", "IsEnabled": "True", "IsTransactional": true}]'
