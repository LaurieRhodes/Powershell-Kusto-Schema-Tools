// ============================================================================
// Azure Data Explorer KQL Script for Malware_Data_CL
// ============================================================================
// Generated: 2025-09-17 06:16:04
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table Malware_Data_CLRaw (records:dynamic)

.alter-merge table Malware_Data_CLRaw policy retention softdelete = 1d

.alter table Malware_Data_CLRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table Malware_Data_CLRaw ingestion json mapping 'Malware_Data_CLRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table Malware_Data_CL(
TimeGenerated:datetime,
TenantId:guid,
campaignScreenshotSet_s:string,
lastPublished_d:real,
firstPublished_d:real,
label_s:string,
executiveSummary_s:string,
hasReport_b:bool,
campaignLanguageSet_s:string,
reportURL_s:string,
threatDetailURL_s:string,
deliveryMechanisms_s:string,
malwareFamilySet_s:string,
threatType_s:string,
secureEmailGatewaySet_s:string,
naicsCodes_s:string,
apiReportURL_s:string,
subjectSet_s:string,
spamUrlSet_s:string,
senderNameSet_s:string,
SourceSystem:string,
MG:string,
ManagementGroupName:string,
Computer:string,
RawData:string,
id_d:real,
relatedSearchTags_s:string,
feeds_s:string,
blockSet_s:string,
campaignBrandSet_s:string,
extractedStringSet_s:string,
domainSet_s:string,
senderEmailSet_s:string,
executableSet_s:string,
senderIpSet_s:string,
ReportDownload_HTML__s:string,
ReportDownload_PDF__s:string,
Type:string,
_ResourceId:string,
_TimeReceived:datetime)

.alter table Malware_Data_CL policy caching hot = 1d

.create-or-alter function Malware_Data_CLExpand() {
Malware_Data_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
TenantId=toguid(events.TenantId),
campaignScreenshotSet_s=tostring(events.campaignScreenshotSet_s),
lastPublished_d=toreal(events.lastPublished_d),
firstPublished_d=toreal(events.firstPublished_d),
label_s=tostring(events.label_s),
executiveSummary_s=tostring(events.executiveSummary_s),
hasReport_b=tobool(events.hasReport_b),
campaignLanguageSet_s=tostring(events.campaignLanguageSet_s),
reportURL_s=tostring(events.reportURL_s),
threatDetailURL_s=tostring(events.threatDetailURL_s),
deliveryMechanisms_s=tostring(events.deliveryMechanisms_s),
malwareFamilySet_s=tostring(events.malwareFamilySet_s),
threatType_s=tostring(events.threatType_s),
secureEmailGatewaySet_s=tostring(events.secureEmailGatewaySet_s),
naicsCodes_s=tostring(events.naicsCodes_s),
apiReportURL_s=tostring(events.apiReportURL_s),
subjectSet_s=tostring(events.subjectSet_s),
spamUrlSet_s=tostring(events.spamUrlSet_s),
senderNameSet_s=tostring(events.senderNameSet_s),
SourceSystem=tostring(events.SourceSystem),
MG=tostring(events.MG),
ManagementGroupName=tostring(events.ManagementGroupName),
Computer=tostring(events.Computer),
RawData=tostring(events.RawData),
id_d=toreal(events.id_d),
relatedSearchTags_s=tostring(events.relatedSearchTags_s),
feeds_s=tostring(events.feeds_s),
blockSet_s=tostring(events.blockSet_s),
campaignBrandSet_s=tostring(events.campaignBrandSet_s),
extractedStringSet_s=tostring(events.extractedStringSet_s),
domainSet_s=tostring(events.domainSet_s),
senderEmailSet_s=tostring(events.senderEmailSet_s),
executableSet_s=tostring(events.executableSet_s),
senderIpSet_s=tostring(events.senderIpSet_s),
ReportDownload_HTML__s=tostring(events.ReportDownload_HTML__s),
ReportDownload_PDF__s=tostring(events.ReportDownload_PDF__s),
Type=tostring(events.Type),
_ResourceId=tostring(events._ResourceId),
_TimeReceived=todatetime(now())
}

.alter table Malware_Data_CL policy update @'[{"Source": "Malware_Data_CLRaw", "Query": "Malware_Data_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
