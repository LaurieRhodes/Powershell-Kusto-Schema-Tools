// ============================================================================
// Azure Data Explorer KQL Script for FncEventsSuricata_CL
// ============================================================================
// Generated: 2025-09-17 06:16:03
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table FncEventsSuricata_CLRaw (records:dynamic)

.alter-merge table FncEventsSuricata_CLRaw policy retention softdelete = 1d

.alter table FncEventsSuricata_CLRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table FncEventsSuricata_CLRaw ingestion json mapping 'FncEventsSuricata_CLRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table FncEventsSuricata_CL(
TimeGenerated:datetime,
timestamp_t:datetime,
http_hostname_enrichments_ip_enrichments_geo_subdivision_s:string,
http_hostname_enrichments_ip_enrichments_geo_location_lon_d:real,
http_hostname_enrichments_ip_enrichments_geo_location_lat_d:real,
http_hostname_enrichments_ip_enrichments_internal_b:bool,
http_hostname_s:string,
http_url_s:string,
http_protocol_s:string,
http_hostname_enrichments_ip_enrichments_geo_city_s:string,
http_status_d:int,
dst_ip_enrichments_annotations_tags_s:string,
dst_ip_enrichments_annotations_roles_s:string,
dst_ip_enrichments_annotations_owners_s:string,
dst_ip_enrichments_annotations_locations_s:string,
dst_ip_enrichments_annotations_environments_s:string,
dst_ip_enrichments_annotations_applications_s:string,
dst_ip_enrichments_asn_asn_org_s:string,
geo_distance_d:real,
dst_ip_enrichments_asn_isp_s:string,
http_hostname_enrichments_ip_enrichments_asn_asn_d:int,
http_hostname_enrichments_ip_enrichments_asn_isp_s:string,
http_xtf_s:string,
http_redirect_s:string,
http_http_user_agent_s:string,
http_http_refer_s:string,
http_http_content_type_s:string,
http_http_method_s:string,
http_length_d:int,
http_hostname_enrichments_ip_enrichments_asn_org_s:string,
http_hostname_enrichments_domain_enrichments_domain_entropy_d:real,
http_hostname_enrichments_ip_enrichments_annotations_roles_s:string,
http_hostname_enrichments_ip_enrichments_annotations_owners_s:string,
http_hostname_enrichments_ip_enrichments_annotations_locations_s:string,
http_hostname_enrichments_ip_enrichments_annotations_environments_s:string,
http_hostname_enrichments_ip_enrichments_annotations_applications_s:string,
http_hostname_enrichments_ip_enrichments_geo_country_s:string,
http_hostname_enrichments_ip_enrichments_asn_asn_org_s:string,
http_hostname_enrichments_ip_enrichments_annotations_tags_s:string,
payload_s:string,
dst_ip_enrichments_asn_org_s:string,
dst_ip_enrichments_geo_city_s:string,
src_ip_enrichments_internal_b:bool,
alert_severity_d:int,
alert_category_s:string,
alert_signature_s:string,
alert_rev_d:int,
alert_signature_id_d:int,
proto_s:string,
src_ip_enrichments_geo_location_lat_d:real,
dest_port_d:real,
src_port_d:real,
src_ip_s:string,
source_s:string,
sensor_id_s:string,
customer_id_s:string,
event_type_s:string,
uuid_g:string,
dest_ip_s:string,
dst_ip_enrichments_asn_asn_d:int,
src_ip_enrichments_geo_location_lon_d:real,
src_ip_enrichments_geo_subdivision_s:string,
dst_ip_enrichments_geo_subdivision_s:string,
dst_ip_enrichments_geo_country_s:string,
dst_ip_enrichments_geo_location_lon_d:real,
dst_ip_enrichments_geo_location_lat_d:real,
dst_ip_enrichments_internal_b:bool,
src_ip_enrichments_annotations_tags_s:string,
src_ip_enrichments_annotations_roles_s:string,
src_ip_enrichments_geo_country_s:string,
src_ip_enrichments_annotations_owners_s:string,
src_ip_enrichments_annotations_environments_s:string,
src_ip_enrichments_annotations_applications_s:string,
src_ip_enrichments_asn_asn_org_s:string,
src_ip_enrichments_asn_isp_s:string,
src_ip_enrichments_asn_org_s:string,
src_ip_enrichments_asn_asn_d:int,
src_ip_enrichments_geo_city_s:string,
src_ip_enrichments_annotations_locations_s:string,
intel_s:string,
Type:string,
_TimeReceived:datetime)

.alter table FncEventsSuricata_CL policy caching hot = 1d

.create-or-alter function FncEventsSuricata_CLExpand() {
FncEventsSuricata_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
timestamp_t=todatetime(events.timestamp_t),
http_hostname_enrichments_ip_enrichments_geo_subdivision_s=tostring(events.http_hostname_enrichments_ip_enrichments_geo_subdivision_s),
http_hostname_enrichments_ip_enrichments_geo_location_lon_d=toreal(events.http_hostname_enrichments_ip_enrichments_geo_location_lon_d),
http_hostname_enrichments_ip_enrichments_geo_location_lat_d=toreal(events.http_hostname_enrichments_ip_enrichments_geo_location_lat_d),
http_hostname_enrichments_ip_enrichments_internal_b=tobool(events.http_hostname_enrichments_ip_enrichments_internal_b),
http_hostname_s=tostring(events.http_hostname_s),
http_url_s=tostring(events.http_url_s),
http_protocol_s=tostring(events.http_protocol_s),
http_hostname_enrichments_ip_enrichments_geo_city_s=tostring(events.http_hostname_enrichments_ip_enrichments_geo_city_s),
http_status_d=toint(events.http_status_d),
dst_ip_enrichments_annotations_tags_s=tostring(events.dst_ip_enrichments_annotations_tags_s),
dst_ip_enrichments_annotations_roles_s=tostring(events.dst_ip_enrichments_annotations_roles_s),
dst_ip_enrichments_annotations_owners_s=tostring(events.dst_ip_enrichments_annotations_owners_s),
dst_ip_enrichments_annotations_locations_s=tostring(events.dst_ip_enrichments_annotations_locations_s),
dst_ip_enrichments_annotations_environments_s=tostring(events.dst_ip_enrichments_annotations_environments_s),
dst_ip_enrichments_annotations_applications_s=tostring(events.dst_ip_enrichments_annotations_applications_s),
dst_ip_enrichments_asn_asn_org_s=tostring(events.dst_ip_enrichments_asn_asn_org_s),
geo_distance_d=toreal(events.geo_distance_d),
dst_ip_enrichments_asn_isp_s=tostring(events.dst_ip_enrichments_asn_isp_s),
http_hostname_enrichments_ip_enrichments_asn_asn_d=toint(events.http_hostname_enrichments_ip_enrichments_asn_asn_d),
http_hostname_enrichments_ip_enrichments_asn_isp_s=tostring(events.http_hostname_enrichments_ip_enrichments_asn_isp_s),
http_xtf_s=tostring(events.http_xtf_s),
http_redirect_s=tostring(events.http_redirect_s),
http_http_user_agent_s=tostring(events.http_http_user_agent_s),
http_http_refer_s=tostring(events.http_http_refer_s),
http_http_content_type_s=tostring(events.http_http_content_type_s),
http_http_method_s=tostring(events.http_http_method_s),
http_length_d=toint(events.http_length_d),
http_hostname_enrichments_ip_enrichments_asn_org_s=tostring(events.http_hostname_enrichments_ip_enrichments_asn_org_s),
http_hostname_enrichments_domain_enrichments_domain_entropy_d=toreal(events.http_hostname_enrichments_domain_enrichments_domain_entropy_d),
http_hostname_enrichments_ip_enrichments_annotations_roles_s=tostring(events.http_hostname_enrichments_ip_enrichments_annotations_roles_s),
http_hostname_enrichments_ip_enrichments_annotations_owners_s=tostring(events.http_hostname_enrichments_ip_enrichments_annotations_owners_s),
http_hostname_enrichments_ip_enrichments_annotations_locations_s=tostring(events.http_hostname_enrichments_ip_enrichments_annotations_locations_s),
http_hostname_enrichments_ip_enrichments_annotations_environments_s=tostring(events.http_hostname_enrichments_ip_enrichments_annotations_environments_s),
http_hostname_enrichments_ip_enrichments_annotations_applications_s=tostring(events.http_hostname_enrichments_ip_enrichments_annotations_applications_s),
http_hostname_enrichments_ip_enrichments_geo_country_s=tostring(events.http_hostname_enrichments_ip_enrichments_geo_country_s),
http_hostname_enrichments_ip_enrichments_asn_asn_org_s=tostring(events.http_hostname_enrichments_ip_enrichments_asn_asn_org_s),
http_hostname_enrichments_ip_enrichments_annotations_tags_s=tostring(events.http_hostname_enrichments_ip_enrichments_annotations_tags_s),
payload_s=tostring(events.payload_s),
dst_ip_enrichments_asn_org_s=tostring(events.dst_ip_enrichments_asn_org_s),
dst_ip_enrichments_geo_city_s=tostring(events.dst_ip_enrichments_geo_city_s),
src_ip_enrichments_internal_b=tobool(events.src_ip_enrichments_internal_b),
alert_severity_d=toint(events.alert_severity_d),
alert_category_s=tostring(events.alert_category_s),
alert_signature_s=tostring(events.alert_signature_s),
alert_rev_d=toint(events.alert_rev_d),
alert_signature_id_d=toint(events.alert_signature_id_d),
proto_s=tostring(events.proto_s),
src_ip_enrichments_geo_location_lat_d=toreal(events.src_ip_enrichments_geo_location_lat_d),
dest_port_d=toreal(events.dest_port_d),
src_port_d=toreal(events.src_port_d),
src_ip_s=tostring(events.src_ip_s),
source_s=tostring(events.source_s),
sensor_id_s=tostring(events.sensor_id_s),
customer_id_s=tostring(events.customer_id_s),
event_type_s=tostring(events.event_type_s),
uuid_g=tostring(events.uuid_g),
dest_ip_s=tostring(events.dest_ip_s),
dst_ip_enrichments_asn_asn_d=toint(events.dst_ip_enrichments_asn_asn_d),
src_ip_enrichments_geo_location_lon_d=toreal(events.src_ip_enrichments_geo_location_lon_d),
src_ip_enrichments_geo_subdivision_s=tostring(events.src_ip_enrichments_geo_subdivision_s),
dst_ip_enrichments_geo_subdivision_s=tostring(events.dst_ip_enrichments_geo_subdivision_s),
dst_ip_enrichments_geo_country_s=tostring(events.dst_ip_enrichments_geo_country_s),
dst_ip_enrichments_geo_location_lon_d=toreal(events.dst_ip_enrichments_geo_location_lon_d),
dst_ip_enrichments_geo_location_lat_d=toreal(events.dst_ip_enrichments_geo_location_lat_d),
dst_ip_enrichments_internal_b=tobool(events.dst_ip_enrichments_internal_b),
src_ip_enrichments_annotations_tags_s=tostring(events.src_ip_enrichments_annotations_tags_s),
src_ip_enrichments_annotations_roles_s=tostring(events.src_ip_enrichments_annotations_roles_s),
src_ip_enrichments_geo_country_s=tostring(events.src_ip_enrichments_geo_country_s),
src_ip_enrichments_annotations_owners_s=tostring(events.src_ip_enrichments_annotations_owners_s),
src_ip_enrichments_annotations_environments_s=tostring(events.src_ip_enrichments_annotations_environments_s),
src_ip_enrichments_annotations_applications_s=tostring(events.src_ip_enrichments_annotations_applications_s),
src_ip_enrichments_asn_asn_org_s=tostring(events.src_ip_enrichments_asn_asn_org_s),
src_ip_enrichments_asn_isp_s=tostring(events.src_ip_enrichments_asn_isp_s),
src_ip_enrichments_asn_org_s=tostring(events.src_ip_enrichments_asn_org_s),
src_ip_enrichments_asn_asn_d=toint(events.src_ip_enrichments_asn_asn_d),
src_ip_enrichments_geo_city_s=tostring(events.src_ip_enrichments_geo_city_s),
src_ip_enrichments_annotations_locations_s=tostring(events.src_ip_enrichments_annotations_locations_s),
intel_s=tostring(events.intel_s),
Type=tostring(events.Type),
_TimeReceived=todatetime(now())
}

.alter table FncEventsSuricata_CL policy update @'[{"Source": "FncEventsSuricata_CLRaw", "Query": "FncEventsSuricata_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
