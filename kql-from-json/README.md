# KQL from JSON

Azure Data Explorer KQL table creation scripts generated from JSON schema exports. Each KQL file contains complete ADX table definitions with ingestion mapping, data transformation, and update policies for cross-platform data migration.

## KQL Script Structure

Each generated script contains a standard template for creating that table in Kusto / ADX:

#### 1. Raw Table Creation

```kusto
.create-merge table GCP_DNS_CLRaw (records:dynamic)
.alter-merge table GCP_DNS_CLRaw policy retention softdelete = 1d
.alter table GCP_DNS_CLRaw policy caching hot = 1h
```

Every table has a "Raw" injection table for receiving dynamic, unstructure records. These records will be transformed almost instantly by your ETL / Expand function into a fully structured data format. Retention of these records is only for troubleshooting purposes.

#### 2. JSON Ingestion Mapping

```kusto
.create-or-alter table GCP_DNS_CLRaw ingestion json mapping 'GCP_DNS_CLRawMapping' 
'[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'
```

For standardisation, a mapping file is created for all Raw tables. The Mapping is used when creating a [Data Connection](https://learn.microsoft.com/en-us/azure/data-explorer/create-event-hubs-connection?tabs=get-data%2Cget-data-2) from Kusto to an Event Hub. It instructs the data pipeline to target incoming data to the records column of the raw table.

Two typical patterns are normally seen with incoming data. Microsoft systems typically export data in a nested format under a records array. Other systems tend to submit event records un-nested. Both patterns are shown in the template.

#### 3. Expansion Function

```kusto
.create-or-alter function GCP_DNS_CLExpand() {
GCP_DNS_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated = todatetime(events.TimeGenerated),
TenantId = toguid(events.TenantId),
payload_vmInstanceId_d = toreal(events.payload_vmInstanceId_d),
payload_serverLatency_d = toreal(events.payload_serverLatency_d),
_TimeReceived = todatetime(now())
}
```

The Expansion function is the ETL process for mapping incoming log events to the currect destination table.

**Important** Depending on the original log source producing nested arrays of events or non-nested sequences of events the ETL may need to mv-expand data for each record to be represented as an individual row of data. Both patterns are included in the template

Data exported directly from Log Analytics tends to have a straightforward 1-to-1 correlation of events. to the intended destination field names. Directly ingested data for other source systems will require some experimentation and often some KQL work to get data to align as expected.

#### 4. Update Policy

```kusto
.alter table GCP_DNS_CL policy update 
@'[{"Source": "GCP_DNS_CLRaw", "Query": "GCP_DNS_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
```

Once an Expand function is doing ETL properly, a table update policy based on events arriving in the Raw table is enabled. This ensures that each record is automatically transformed in realtime.

## Data Type Corrections Applied

### Microsoft API Bug Fixes

- **TenantId**: `string` → `guid` → `TenantId:guid` in ADX
- **WorkspaceId**: `string` → `guid` → `WorkspaceId:guid` in ADX
- **TimeGenerated**: `string` → `datetime` → `TimeGenerated:datetime` in ADX
- **Double**: `double` → `real` → `ColumnName:real` in ADX

### ADX Type Mappings

| Log Analytics Type | ADX Type   | Conversion Function |
| ------------------ | ---------- | ------------------- |
| `string`           | `string`   | `tostring()`        |
| `datetime`         | `datetime` | `todatetime()`      |
| `guid`             | `guid`     | `toguid()`          |
| `real`             | `real`     | `toreal()`          |
| `int`              | `int`      | `toint()`           |
| `long`             | `long`     | `tolong()`          |
| `bool`             | `bool`     | `tobool()`          |
| `dynamic`          | `dynamic`  | `todynamic()`       |

## Source Generation

Generated by `json-to-adx-kql-export.ps1` from standardized JSON schema exports with automated ADX-specific optimizations and ingestion mapping.