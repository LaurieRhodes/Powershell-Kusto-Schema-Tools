// ============================================================================
// Azure Data Explorer KQL Script for TaniumThreatResponse_CL
// ============================================================================
// Generated: 2025-09-17 06:16:07
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table TaniumThreatResponse_CLRaw (records:dynamic)

.alter-merge table TaniumThreatResponse_CLRaw policy retention softdelete = 1d

.alter table TaniumThreatResponse_CLRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table TaniumThreatResponse_CLRaw ingestion json mapping 'TaniumThreatResponse_CLRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table TaniumThreatResponse_CL(
TimeGenerated:datetime,
Alert_Id_g:string,
Match_Details_match_properties_file_md5_s:string,
Match_Details_match_properties_fullpath_s:string,
Match_Details_match_properties_md5_g:string,
Match_Details_match_properties_md5_s:string,
Match_Details_match_properties_name_s:string,
Match_Details_match_properties_parent_args_s:string,
Match_Details_match_properties_parent_file_s:string,
Match_Details_match_properties_parent_name_s:string,
Match_Details_match_properties_parent_parent_s:string,
Match_Details_match_properties_parent_pid_d:real,
Match_Details_match_properties_parent_ppid_d:real,
Match_Details_match_properties_parent_recorder_unique_id_s:string,
Match_Details_match_properties_parent_start_time_s:string,
Match_Details_match_properties_parent_start_time_t:datetime,
Match_Details_match_properties_file_md5_g:string,
Match_Details_match_properties_parent_user_s:string,
Match_Details_match_properties_ppid_d:real,
Match_Details_match_properties_recorder_unique_id_s:string,
Match_Details_match_properties_sha1_s:string,
Match_Details_match_properties_sha256_s:string,
Match_Details_match_properties_size_d:real,
Match_Details_match_properties_start_time_s:string,
Match_Details_match_properties_start_time_t:datetime,
Match_Details_match_properties_user_s:string,
Match_Details_match_source_s:string,
Match_Details_match_type_s:string,
Match_Details_match_version_d:real,
Match_Details_service_id_g:string,
MITRE_Techniques_s:string,
RawData:string,
Match_Details_match_properties_pid_d:real,
Timestamp_s:string,
Match_Details_match_properties_file_fullpath_s:string,
Match_Details_match_properties_args_s:string,
Computer:string,
Computer_IP_s:string,
Computer_Name_s:string,
fake_b:bool,
Impact_Score_d:real,
Impact_Score_s:string,
Intel_Id_d:real,
Intel_Labels_s:string,
Intel_Name_s:string,
Intel_Type_s:string,
Match_Details_finding_artifact_artifact_hash_s:string,
Match_Details_finding_artifact_instance_hash_s:string,
Match_Details_finding_artifact_windows_defender_event_event_s:string,
Match_Details_finding_artifact_windows_defender_event_timestamp_ms_s:string,
Match_Details_match_properties_cwd_s:string,
Match_Details_finding_description_s:string,
Match_Details_finding_hunt_id_s:string,
Match_Details_finding_intel_id_s:string,
Match_Details_finding_last_seen_t:datetime,
Match_Details_finding_source_name_s:string,
Match_Details_finding_system_info_bits_d:real,
Match_Details_finding_system_info_build_number_s:string,
Match_Details_finding_system_info_os_s:string,
Match_Details_finding_system_info_patch_level_s:string,
Match_Details_finding_system_info_platform_s:string,
Match_Details_finding_threat_id_s:string,
Match_Details_finding_whats_s:string,
Match_Details_hash_d:real,
Match_Details_match_contexts_s:string,
Match_Details_match_hash_d:real,
Match_Details_finding_first_seen_t:datetime,
Timestamp_t:datetime,
Type:string,
_TimeReceived:datetime)

.alter table TaniumThreatResponse_CL policy caching hot = 1d

.create-or-alter function TaniumThreatResponse_CLExpand() {
TaniumThreatResponse_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
Alert_Id_g=tostring(events.Alert_Id_g),
Match_Details_match_properties_file_md5_s=tostring(events.Match_Details_match_properties_file_md5_s),
Match_Details_match_properties_fullpath_s=tostring(events.Match_Details_match_properties_fullpath_s),
Match_Details_match_properties_md5_g=tostring(events.Match_Details_match_properties_md5_g),
Match_Details_match_properties_md5_s=tostring(events.Match_Details_match_properties_md5_s),
Match_Details_match_properties_name_s=tostring(events.Match_Details_match_properties_name_s),
Match_Details_match_properties_parent_args_s=tostring(events.Match_Details_match_properties_parent_args_s),
Match_Details_match_properties_parent_file_s=tostring(events.Match_Details_match_properties_parent_file_s),
Match_Details_match_properties_parent_name_s=tostring(events.Match_Details_match_properties_parent_name_s),
Match_Details_match_properties_parent_parent_s=tostring(events.Match_Details_match_properties_parent_parent_s),
Match_Details_match_properties_parent_pid_d=toreal(events.Match_Details_match_properties_parent_pid_d),
Match_Details_match_properties_parent_ppid_d=toreal(events.Match_Details_match_properties_parent_ppid_d),
Match_Details_match_properties_parent_recorder_unique_id_s=tostring(events.Match_Details_match_properties_parent_recorder_unique_id_s),
Match_Details_match_properties_parent_start_time_s=tostring(events.Match_Details_match_properties_parent_start_time_s),
Match_Details_match_properties_parent_start_time_t=todatetime(events.Match_Details_match_properties_parent_start_time_t),
Match_Details_match_properties_file_md5_g=tostring(events.Match_Details_match_properties_file_md5_g),
Match_Details_match_properties_parent_user_s=tostring(events.Match_Details_match_properties_parent_user_s),
Match_Details_match_properties_ppid_d=toreal(events.Match_Details_match_properties_ppid_d),
Match_Details_match_properties_recorder_unique_id_s=tostring(events.Match_Details_match_properties_recorder_unique_id_s),
Match_Details_match_properties_sha1_s=tostring(events.Match_Details_match_properties_sha1_s),
Match_Details_match_properties_sha256_s=tostring(events.Match_Details_match_properties_sha256_s),
Match_Details_match_properties_size_d=toreal(events.Match_Details_match_properties_size_d),
Match_Details_match_properties_start_time_s=tostring(events.Match_Details_match_properties_start_time_s),
Match_Details_match_properties_start_time_t=todatetime(events.Match_Details_match_properties_start_time_t),
Match_Details_match_properties_user_s=tostring(events.Match_Details_match_properties_user_s),
Match_Details_match_source_s=tostring(events.Match_Details_match_source_s),
Match_Details_match_type_s=tostring(events.Match_Details_match_type_s),
Match_Details_match_version_d=toreal(events.Match_Details_match_version_d),
Match_Details_service_id_g=tostring(events.Match_Details_service_id_g),
MITRE_Techniques_s=tostring(events.MITRE_Techniques_s),
RawData=tostring(events.RawData),
Match_Details_match_properties_pid_d=toreal(events.Match_Details_match_properties_pid_d),
Timestamp_s=tostring(events.Timestamp_s),
Match_Details_match_properties_file_fullpath_s=tostring(events.Match_Details_match_properties_file_fullpath_s),
Match_Details_match_properties_args_s=tostring(events.Match_Details_match_properties_args_s),
Computer=tostring(events.Computer),
Computer_IP_s=tostring(events.Computer_IP_s),
Computer_Name_s=tostring(events.Computer_Name_s),
fake_b=tobool(events.fake_b),
Impact_Score_d=toreal(events.Impact_Score_d),
Impact_Score_s=tostring(events.Impact_Score_s),
Intel_Id_d=toreal(events.Intel_Id_d),
Intel_Labels_s=tostring(events.Intel_Labels_s),
Intel_Name_s=tostring(events.Intel_Name_s),
Intel_Type_s=tostring(events.Intel_Type_s),
Match_Details_finding_artifact_artifact_hash_s=tostring(events.Match_Details_finding_artifact_artifact_hash_s),
Match_Details_finding_artifact_instance_hash_s=tostring(events.Match_Details_finding_artifact_instance_hash_s),
Match_Details_finding_artifact_windows_defender_event_event_s=tostring(events.Match_Details_finding_artifact_windows_defender_event_event_s),
Match_Details_finding_artifact_windows_defender_event_timestamp_ms_s=tostring(events.Match_Details_finding_artifact_windows_defender_event_timestamp_ms_s),
Match_Details_match_properties_cwd_s=tostring(events.Match_Details_match_properties_cwd_s),
Match_Details_finding_description_s=tostring(events.Match_Details_finding_description_s),
Match_Details_finding_hunt_id_s=tostring(events.Match_Details_finding_hunt_id_s),
Match_Details_finding_intel_id_s=tostring(events.Match_Details_finding_intel_id_s),
Match_Details_finding_last_seen_t=todatetime(events.Match_Details_finding_last_seen_t),
Match_Details_finding_source_name_s=tostring(events.Match_Details_finding_source_name_s),
Match_Details_finding_system_info_bits_d=toreal(events.Match_Details_finding_system_info_bits_d),
Match_Details_finding_system_info_build_number_s=tostring(events.Match_Details_finding_system_info_build_number_s),
Match_Details_finding_system_info_os_s=tostring(events.Match_Details_finding_system_info_os_s),
Match_Details_finding_system_info_patch_level_s=tostring(events.Match_Details_finding_system_info_patch_level_s),
Match_Details_finding_system_info_platform_s=tostring(events.Match_Details_finding_system_info_platform_s),
Match_Details_finding_threat_id_s=tostring(events.Match_Details_finding_threat_id_s),
Match_Details_finding_whats_s=tostring(events.Match_Details_finding_whats_s),
Match_Details_hash_d=toreal(events.Match_Details_hash_d),
Match_Details_match_contexts_s=tostring(events.Match_Details_match_contexts_s),
Match_Details_match_hash_d=toreal(events.Match_Details_match_hash_d),
Match_Details_finding_first_seen_t=todatetime(events.Match_Details_finding_first_seen_t),
Timestamp_t=todatetime(events.Timestamp_t),
Type=tostring(events.Type),
_TimeReceived=todatetime(now())
}

.alter table TaniumThreatResponse_CL policy update @'[{"Source": "TaniumThreatResponse_CLRaw", "Query": "TaniumThreatResponse_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
