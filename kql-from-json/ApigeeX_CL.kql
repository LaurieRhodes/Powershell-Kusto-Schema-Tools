// ============================================================================
// Azure Data Explorer KQL Script for ApigeeX_CL
// ============================================================================
// Generated: 2025-09-19 14:22:58
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table ApigeeX_CLRaw (records:dynamic)

.alter-merge table ApigeeX_CLRaw policy retention softdelete = 1d

.alter table ApigeeX_CLRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table ApigeeX_CLRaw ingestion json mapping 'ApigeeX_CLRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table ApigeeX_CL(
TimeGenerated:datetime,
TenantId:guid,
payload_authenticationInfo_principalEmail:string,
payload_requestMetadata_callerIp:string,
payload_requestMetadata_callerSuppliedUserAgent:string,
payload_serviceName:string,
payload_methodName:string,
payload_authorizationInfo:string,
payload_resourceName:string,
payload_request_instanceUid:string,
payload_request_instance:string,
payload_request__type:string,
payload_request_resources:string,
payload__type:string,
payload_request_environmenteploymentType:string,
payload_request_environmentisplayName:string,
payload_response_type:string,
payload_responseisplayName:string,
payload_responseeploymentType:string,
payloadtatus_code:string,
payloadtatus_message:string,
payload_requestMetadata_requestAttributesime:datetime,
insert_id:string,
resourceype:string,
resource_labelservice:string,
payload_type:string,
payload_request_environmentescription:string,
resource_labels_project_id:string,
resource_labels_service:string,
resource_labels_method:string,
SourceSystem:string,
MG:string,
ManagementGroupName:string,
Computer:string,
RawData:string,
payload_request_name:string,
payload_request_environment_apiProxyType:string,
payload_request_environment_deploymentType:string,
payload_request_environment_description:string,
payload_request_environment_displayName:string,
payload_request_environment_name:string,
payload_response__type:string,
payload_response_name:string,
payload_response_displayName:string,
payload_response_deploymentType:string,
payload_response_apiProxyType:string,
payload_status_code:string,
payload_status_message:string,
payload_request_reportTime:string,
payload_requestMetadata_requestAttributes_time:datetime,
log_name:string,
insert_id_:string,
severity:string,
timestamp:datetime,
resource_type:string,
payloaderviceName:string,
payload_request_type:string,
Type:string,
_ResourceId:string,
_TimeReceived:datetime)

.alter table ApigeeX_CL policy caching hot = 1d

.create-or-alter function ApigeeX_CLExpand() {
ApigeeX_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
TenantId=toguid(events.TenantId),
payload_authenticationInfo_principalEmail=tostring(events.payload_authenticationInfo_principalEmail),
payload_requestMetadata_callerIp=tostring(events.payload_requestMetadata_callerIp),
payload_requestMetadata_callerSuppliedUserAgent=tostring(events.payload_requestMetadata_callerSuppliedUserAgent),
payload_serviceName=tostring(events.payload_serviceName),
payload_methodName=tostring(events.payload_methodName),
payload_authorizationInfo=tostring(events.payload_authorizationInfo),
payload_resourceName=tostring(events.payload_resourceName),
payload_request_instanceUid=tostring(events.payload_request_instanceUid),
payload_request_instance=tostring(events.payload_request_instance),
payload_request__type=tostring(events.payload_request__type),
payload_request_resources=tostring(events.payload_request_resources),
payload__type=tostring(events.payload__type),
payload_request_environmenteploymentType=tostring(events.payload_request_environmenteploymentType),
payload_request_environmentisplayName=tostring(events.payload_request_environmentisplayName),
payload_response_type=tostring(events.payload_response_type),
payload_responseisplayName=tostring(events.payload_responseisplayName),
payload_responseeploymentType=tostring(events.payload_responseeploymentType),
payloadtatus_code=tostring(events.payloadtatus_code),
payloadtatus_message=tostring(events.payloadtatus_message),
payload_requestMetadata_requestAttributesime=todatetime(events.payload_requestMetadata_requestAttributesime),
insert_id=tostring(events.insert_id),
resourceype=tostring(events.resourceype),
resource_labelservice=tostring(events.resource_labelservice),
payload_type=tostring(events.payload_type),
payload_request_environmentescription=tostring(events.payload_request_environmentescription),
resource_labels_project_id=tostring(events.resource_labels_project_id),
resource_labels_service=tostring(events.resource_labels_service),
resource_labels_method=tostring(events.resource_labels_method),
SourceSystem=tostring(events.SourceSystem),
MG=tostring(events.MG),
ManagementGroupName=tostring(events.ManagementGroupName),
Computer=tostring(events.Computer),
RawData=tostring(events.RawData),
payload_request_name=tostring(events.payload_request_name),
payload_request_environment_apiProxyType=tostring(events.payload_request_environment_apiProxyType),
payload_request_environment_deploymentType=tostring(events.payload_request_environment_deploymentType),
payload_request_environment_description=tostring(events.payload_request_environment_description),
payload_request_environment_displayName=tostring(events.payload_request_environment_displayName),
payload_request_environment_name=tostring(events.payload_request_environment_name),
payload_response__type=tostring(events.payload_response__type),
payload_response_name=tostring(events.payload_response_name),
payload_response_displayName=tostring(events.payload_response_displayName),
payload_response_deploymentType=tostring(events.payload_response_deploymentType),
payload_response_apiProxyType=tostring(events.payload_response_apiProxyType),
payload_status_code=tostring(events.payload_status_code),
payload_status_message=tostring(events.payload_status_message),
payload_request_reportTime=tostring(events.payload_request_reportTime),
payload_requestMetadata_requestAttributes_time=todatetime(events.payload_requestMetadata_requestAttributes_time),
log_name=tostring(events.log_name),
insert_id_=tostring(events.insert_id_),
severity=tostring(events.severity),
timestamp=todatetime(events.timestamp),
resource_type=tostring(events.resource_type),
payloaderviceName=tostring(events.payloaderviceName),
payload_request_type=tostring(events.payload_request_type),
Type=tostring(events.Type),
_ResourceId=tostring(events._ResourceId),
_TimeReceived=todatetime(now())
}

.alter table ApigeeX_CL policy update @'[{"Source": "ApigeeX_CLRaw", "Query": "ApigeeX_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
