// ============================================================================
// Azure Data Explorer KQL Script for CarbonBlackEvents_CL
// ============================================================================
// Generated: 2025-09-17 06:15:57
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table CarbonBlackEvents_CLRaw (records:dynamic)

.alter-merge table CarbonBlackEvents_CLRaw policy retention softdelete = 1d

.alter table CarbonBlackEvents_CLRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table CarbonBlackEvents_CLRaw ingestion json mapping 'CarbonBlackEvents_CLRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table CarbonBlackEvents_CL(
TimeGenerated:datetime,
eventTime_d:datetime,
device_group_s:string,
deviceDetails_msmGroupName_s:string,
local_port_d:real,
parent_hash_s:string,
processDetails_parentPid_d:real,
device_os_s:string,
device_external_ip_s:string,
backend_timestamp_s:string,
parent_path_s:string,
parent_pid_d:real,
parent_cmdline_s:string,
sensor_action_s:string,
longDescription_s:string,
process_path_s:string,
device_name_s:string,
type_s:string,
processDetails_parentName_s:string,
process_username_s:string,
eventTime_s:string,
createTime_s:string,
netconn_inbound_b:bool,
parent_reputation_s:string,
local_ip_s:string,
processDetails_targetCommandLine_s:string,
event_origin_s:string,
childproc_hash_s:string,
org_key_s:string,
remote_ip_s:string,
process_pid_d:real,
deviceDetails_deviceIpV4Address_s:string,
netconn_domain_s:string,
netFlow_peerFqdn_s:string,
process_reputation_s:string,
eventId_g:string,
processDetails_parentCommandLine_s:string,
remote_port_d:real,
eventType_s:string,
schema_d:real,
netconn_protocol_s:string,
action_s:string,
device_id_s:string,
process_hash_s:string,
shortDescription_s:string,
deviceDetails_deviceId_s:string,
process_cmdline_s:string,
deviceDetails_deviceType_s:string,
device_timestamp_s:string,
event_id_g:string,
processDetails_commandLine_s:string,
process_terminated_b:bool,
event_description_s:string,
processDetails_processId_d:real,
process_guid_s:string,
parent_guid_s:string,
childproc_guid_s:string,
childproc_name_s:string,
scriptload_publisher_s:string,
scriptload_effective_reputation_s:string,
process_fork_pid_d:real,
securityEventCode_g:string,
alert_id_g:string,
incidentId_g:string,
scriptload_content_s:string,
scriptload_content_length_d:real,
scriptload_hash_s:string,
fileless_scriptload_cmdline_s:string,
fileless_scriptload_cmdline_length_d:real,
scriptload_count_d:real,
fileless_scriptload_hash_s:string,
RawData:string,
Computer:string,
ManagementGroupName:string,
MG:string,
SourceSystem:string,
TenantId:guid,
processDetails_targetName_s:string,
processDetails_fullUserName_s:string,
deviceDetails_deviceIpAddress_s:string,
deviceDetails_deviceName_s:string,
targetApp_effectiveReputation_s:string,
modload_md5_s:string,
childproc_reputation_s:string,
scriptload_reputation_s:string,
childproc_publisher_s:string,
childproc_pid_d:real,
childproc_username_s:string,
target_cmdline_s:string,
regmod_name_s:string,
crossproc_api_s:string,
process_duration_d:real,
modload_count_d:real,
modload_sha256_s:string,
modload_name_s:string,
modload_effective_reputation_s:string,
modload_hash_s:string,
scriptload_name_s:string,
modload_publisher_s:string,
netconn_community_id_s:string,
filemod_hash_s:string,
filemod_name_s:string,
process_publisher_s:string,
crossproc_reputation_s:string,
crossproc_target_b:bool,
crossproc_publisher_s:string,
crossproc_action_s:string,
crossproc_guid_s:string,
crossproc_hash_s:string,
crossproc_name_s:string,
modload_md5_g:string,
netFlow_peerIpAddress_s:string,
Type:string,
_ResourceId:string,
_ItemId:string,
_TimeReceived:datetime)

.alter table CarbonBlackEvents_CL policy caching hot = 1d

.create-or-alter function CarbonBlackEvents_CLExpand() {
CarbonBlackEvents_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
eventTime_d=todatetime(events.eventTime_d),
device_group_s=tostring(events.device_group_s),
deviceDetails_msmGroupName_s=tostring(events.deviceDetails_msmGroupName_s),
local_port_d=toreal(events.local_port_d),
parent_hash_s=tostring(events.parent_hash_s),
processDetails_parentPid_d=toreal(events.processDetails_parentPid_d),
device_os_s=tostring(events.device_os_s),
device_external_ip_s=tostring(events.device_external_ip_s),
backend_timestamp_s=tostring(events.backend_timestamp_s),
parent_path_s=tostring(events.parent_path_s),
parent_pid_d=toreal(events.parent_pid_d),
parent_cmdline_s=tostring(events.parent_cmdline_s),
sensor_action_s=tostring(events.sensor_action_s),
longDescription_s=tostring(events.longDescription_s),
process_path_s=tostring(events.process_path_s),
device_name_s=tostring(events.device_name_s),
type_s=tostring(events.type_s),
processDetails_parentName_s=tostring(events.processDetails_parentName_s),
process_username_s=tostring(events.process_username_s),
eventTime_s=tostring(events.eventTime_s),
createTime_s=tostring(events.createTime_s),
netconn_inbound_b=tobool(events.netconn_inbound_b),
parent_reputation_s=tostring(events.parent_reputation_s),
local_ip_s=tostring(events.local_ip_s),
processDetails_targetCommandLine_s=tostring(events.processDetails_targetCommandLine_s),
event_origin_s=tostring(events.event_origin_s),
childproc_hash_s=tostring(events.childproc_hash_s),
org_key_s=tostring(events.org_key_s),
remote_ip_s=tostring(events.remote_ip_s),
process_pid_d=toreal(events.process_pid_d),
deviceDetails_deviceIpV4Address_s=tostring(events.deviceDetails_deviceIpV4Address_s),
netconn_domain_s=tostring(events.netconn_domain_s),
netFlow_peerFqdn_s=tostring(events.netFlow_peerFqdn_s),
process_reputation_s=tostring(events.process_reputation_s),
eventId_g=tostring(events.eventId_g),
processDetails_parentCommandLine_s=tostring(events.processDetails_parentCommandLine_s),
remote_port_d=toreal(events.remote_port_d),
eventType_s=tostring(events.eventType_s),
schema_d=toreal(events.schema_d),
netconn_protocol_s=tostring(events.netconn_protocol_s),
action_s=tostring(events.action_s),
device_id_s=tostring(events.device_id_s),
process_hash_s=tostring(events.process_hash_s),
shortDescription_s=tostring(events.shortDescription_s),
deviceDetails_deviceId_s=tostring(events.deviceDetails_deviceId_s),
process_cmdline_s=tostring(events.process_cmdline_s),
deviceDetails_deviceType_s=tostring(events.deviceDetails_deviceType_s),
device_timestamp_s=tostring(events.device_timestamp_s),
event_id_g=tostring(events.event_id_g),
processDetails_commandLine_s=tostring(events.processDetails_commandLine_s),
process_terminated_b=tobool(events.process_terminated_b),
event_description_s=tostring(events.event_description_s),
processDetails_processId_d=toreal(events.processDetails_processId_d),
process_guid_s=tostring(events.process_guid_s),
parent_guid_s=tostring(events.parent_guid_s),
childproc_guid_s=tostring(events.childproc_guid_s),
childproc_name_s=tostring(events.childproc_name_s),
scriptload_publisher_s=tostring(events.scriptload_publisher_s),
scriptload_effective_reputation_s=tostring(events.scriptload_effective_reputation_s),
process_fork_pid_d=toreal(events.process_fork_pid_d),
securityEventCode_g=tostring(events.securityEventCode_g),
alert_id_g=tostring(events.alert_id_g),
incidentId_g=tostring(events.incidentId_g),
scriptload_content_s=tostring(events.scriptload_content_s),
scriptload_content_length_d=toreal(events.scriptload_content_length_d),
scriptload_hash_s=tostring(events.scriptload_hash_s),
fileless_scriptload_cmdline_s=tostring(events.fileless_scriptload_cmdline_s),
fileless_scriptload_cmdline_length_d=toreal(events.fileless_scriptload_cmdline_length_d),
scriptload_count_d=toreal(events.scriptload_count_d),
fileless_scriptload_hash_s=tostring(events.fileless_scriptload_hash_s),
RawData=tostring(events.RawData),
Computer=tostring(events.Computer),
ManagementGroupName=tostring(events.ManagementGroupName),
MG=tostring(events.MG),
SourceSystem=tostring(events.SourceSystem),
TenantId=toguid(events.TenantId),
processDetails_targetName_s=tostring(events.processDetails_targetName_s),
processDetails_fullUserName_s=tostring(events.processDetails_fullUserName_s),
deviceDetails_deviceIpAddress_s=tostring(events.deviceDetails_deviceIpAddress_s),
deviceDetails_deviceName_s=tostring(events.deviceDetails_deviceName_s),
targetApp_effectiveReputation_s=tostring(events.targetApp_effectiveReputation_s),
modload_md5_s=tostring(events.modload_md5_s),
childproc_reputation_s=tostring(events.childproc_reputation_s),
scriptload_reputation_s=tostring(events.scriptload_reputation_s),
childproc_publisher_s=tostring(events.childproc_publisher_s),
childproc_pid_d=toreal(events.childproc_pid_d),
childproc_username_s=tostring(events.childproc_username_s),
target_cmdline_s=tostring(events.target_cmdline_s),
regmod_name_s=tostring(events.regmod_name_s),
crossproc_api_s=tostring(events.crossproc_api_s),
process_duration_d=toreal(events.process_duration_d),
modload_count_d=toreal(events.modload_count_d),
modload_sha256_s=tostring(events.modload_sha256_s),
modload_name_s=tostring(events.modload_name_s),
modload_effective_reputation_s=tostring(events.modload_effective_reputation_s),
modload_hash_s=tostring(events.modload_hash_s),
scriptload_name_s=tostring(events.scriptload_name_s),
modload_publisher_s=tostring(events.modload_publisher_s),
netconn_community_id_s=tostring(events.netconn_community_id_s),
filemod_hash_s=tostring(events.filemod_hash_s),
filemod_name_s=tostring(events.filemod_name_s),
process_publisher_s=tostring(events.process_publisher_s),
crossproc_reputation_s=tostring(events.crossproc_reputation_s),
crossproc_target_b=tobool(events.crossproc_target_b),
crossproc_publisher_s=tostring(events.crossproc_publisher_s),
crossproc_action_s=tostring(events.crossproc_action_s),
crossproc_guid_s=tostring(events.crossproc_guid_s),
crossproc_hash_s=tostring(events.crossproc_hash_s),
crossproc_name_s=tostring(events.crossproc_name_s),
modload_md5_g=tostring(events.modload_md5_g),
netFlow_peerIpAddress_s=tostring(events.netFlow_peerIpAddress_s),
Type=tostring(events.Type),
_ResourceId=tostring(events._ResourceId),
_ItemId=tostring(events._ItemId),
_TimeReceived=todatetime(now())
}

.alter table CarbonBlackEvents_CL policy update @'[{"Source": "CarbonBlackEvents_CLRaw", "Query": "CarbonBlackEvents_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
