// ============================================================================
// Azure Data Explorer KQL Script for GCP_IAM_CL
// ============================================================================
// Generated: 2025-09-13 20:17:14
// Table type: Custom (presumed for JSON exports)
// Schema imported from JSON export file
// ============================================================================

.create-merge table GCP_IAM_CLRaw (records:dynamic)

.alter-merge table GCP_IAM_CLRaw policy retention softdelete = 1d

.alter table GCP_IAM_CLRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table GCP_IAM_CLRaw ingestion json mapping 'GCP_IAM_CLRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table GCP_IAM_CL(
TimeGenerated:datetime,
payload_status_code_d:real,
payload_response_etag_s:string,
payload_response_name_s:string,
payload_response_oauth2_client_id_s:string,
payload_request_service_account_display_name_s:string,
payload_request_service_account_description_s:string,
payload_request_account_id_s:string,
payload_request_name_s:string,
payload_request__type_s:string,
payload_resourceName_s:string,
payload_authorizationInfo_s:string,
payload_methodName_s:string,
payload_serviceName_s:string,
payload_requestMetadata_requestAttributes_time_s:string,
payload_requestMetadata_callerSuppliedUserAgent_s:string,
payload_requestMetadata_callerIp_s:string,
payload_response_unique_id_s:string,
payload_authenticationInfo_principalSubject_s:string,
payload_response_description_s:string,
payload_response_display_name_s:string,
payload_request_options_requested_policy_version_d:real,
payload_request_full_resource_name_s:string,
resource_labels_method_s:string,
resource_labels_location_s:string,
resource_labels_version_s:string,
resource_labels_service_s:string,
payload_response_key_algorithm_d:real,
payload_response_private_key_type_d:real,
payload_response_key_origin_d:real,
payload_response_key_type_d:real,
payload_response_valid_after_time_seconds_d:real,
payload_response_valid_before_time_seconds_d:real,
payload_request_private_key_type_d:real,
payload_response_email_s:string,
payload_response__type_s:string,
payload_response_project_id_s:string,
payload_authenticationInfo_principalEmail_s:string,
payload__type_s:string,
resource_labels_unique_id_s:string,
payload_request_view_d:real,
payload_request_remove_deleted_service_accounts_b:bool,
payload_request_page_size_d:real,
payload_response_auditConfigs_s:string,
payload_response_bindings_s:string,
payload_request_resource_s:string,
payload_request_policy_bindings_s:string,
payload_request_policy_etag_s:string,
payload_request_policy_auditConfigs_s:string,
payload_serviceData_policyDelta_bindingDeltas_s:string,
resource_labels_topic_id_s:string,
payload_request_update_mask_paths_s:string,
payload_serviceData_permissionDelta_removedPermissions_s:string,
payload_request_key_types_s:string,
payload_status_message_s:string,
payload_request_parent_s:string,
payload_request_show_deleted_b:bool,
resource_labels_role_name_s:string,
payload_serviceData__type_s:string,
resource_labels_project_id_s:string,
resource_labels_email_id_s:string,
resource_type_s:string,
timestamp_t:datetime,
severity_s:string,
insert_id_s:string,
log_name_s:string,
payload_request_skip_visibility_check_b:bool,
payload_response_group_title_s:string,
payload_response_included_permissions_s:string,
payload_response_group_name_s:string,
payload_request_role_id_s:string,
payload_request_role_description_s:string,
payload_request_role_title_s:string,
payload_request_role_included_permissions_s:string,
payload_serviceData_permissionDelta_addedPermissions_s:string,
payload_response_title_s:string,
payload_request_page_token_s:string,
_TimeReceived:datetime)

.alter table GCP_IAM_CL policy caching hot = 1d

.create-or-alter function GCP_IAM_CLExpand() {
GCP_IAM_CLRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
payload_status_code_d=toreal(events.payload_status_code_d),
payload_response_etag_s=tostring(events.payload_response_etag_s),
payload_response_name_s=tostring(events.payload_response_name_s),
payload_response_oauth2_client_id_s=tostring(events.payload_response_oauth2_client_id_s),
payload_request_service_account_display_name_s=tostring(events.payload_request_service_account_display_name_s),
payload_request_service_account_description_s=tostring(events.payload_request_service_account_description_s),
payload_request_account_id_s=tostring(events.payload_request_account_id_s),
payload_request_name_s=tostring(events.payload_request_name_s),
payload_request__type_s=tostring(events.payload_request__type_s),
payload_resourceName_s=tostring(events.payload_resourceName_s),
payload_authorizationInfo_s=tostring(events.payload_authorizationInfo_s),
payload_methodName_s=tostring(events.payload_methodName_s),
payload_serviceName_s=tostring(events.payload_serviceName_s),
payload_requestMetadata_requestAttributes_time_s=tostring(events.payload_requestMetadata_requestAttributes_time_s),
payload_requestMetadata_callerSuppliedUserAgent_s=tostring(events.payload_requestMetadata_callerSuppliedUserAgent_s),
payload_requestMetadata_callerIp_s=tostring(events.payload_requestMetadata_callerIp_s),
payload_response_unique_id_s=tostring(events.payload_response_unique_id_s),
payload_authenticationInfo_principalSubject_s=tostring(events.payload_authenticationInfo_principalSubject_s),
payload_response_description_s=tostring(events.payload_response_description_s),
payload_response_display_name_s=tostring(events.payload_response_display_name_s),
payload_request_options_requested_policy_version_d=toreal(events.payload_request_options_requested_policy_version_d),
payload_request_full_resource_name_s=tostring(events.payload_request_full_resource_name_s),
resource_labels_method_s=tostring(events.resource_labels_method_s),
resource_labels_location_s=tostring(events.resource_labels_location_s),
resource_labels_version_s=tostring(events.resource_labels_version_s),
resource_labels_service_s=tostring(events.resource_labels_service_s),
payload_response_key_algorithm_d=toreal(events.payload_response_key_algorithm_d),
payload_response_private_key_type_d=toreal(events.payload_response_private_key_type_d),
payload_response_key_origin_d=toreal(events.payload_response_key_origin_d),
payload_response_key_type_d=toreal(events.payload_response_key_type_d),
payload_response_valid_after_time_seconds_d=toreal(events.payload_response_valid_after_time_seconds_d),
payload_response_valid_before_time_seconds_d=toreal(events.payload_response_valid_before_time_seconds_d),
payload_request_private_key_type_d=toreal(events.payload_request_private_key_type_d),
payload_response_email_s=tostring(events.payload_response_email_s),
payload_response__type_s=tostring(events.payload_response__type_s),
payload_response_project_id_s=tostring(events.payload_response_project_id_s),
payload_authenticationInfo_principalEmail_s=tostring(events.payload_authenticationInfo_principalEmail_s),
payload__type_s=tostring(events.payload__type_s),
resource_labels_unique_id_s=tostring(events.resource_labels_unique_id_s),
payload_request_view_d=toreal(events.payload_request_view_d),
payload_request_remove_deleted_service_accounts_b=tobool(events.payload_request_remove_deleted_service_accounts_b),
payload_request_page_size_d=toreal(events.payload_request_page_size_d),
payload_response_auditConfigs_s=tostring(events.payload_response_auditConfigs_s),
payload_response_bindings_s=tostring(events.payload_response_bindings_s),
payload_request_resource_s=tostring(events.payload_request_resource_s),
payload_request_policy_bindings_s=tostring(events.payload_request_policy_bindings_s),
payload_request_policy_etag_s=tostring(events.payload_request_policy_etag_s),
payload_request_policy_auditConfigs_s=tostring(events.payload_request_policy_auditConfigs_s),
payload_serviceData_policyDelta_bindingDeltas_s=tostring(events.payload_serviceData_policyDelta_bindingDeltas_s),
resource_labels_topic_id_s=tostring(events.resource_labels_topic_id_s),
payload_request_update_mask_paths_s=tostring(events.payload_request_update_mask_paths_s),
payload_serviceData_permissionDelta_removedPermissions_s=tostring(events.payload_serviceData_permissionDelta_removedPermissions_s),
payload_request_key_types_s=tostring(events.payload_request_key_types_s),
payload_status_message_s=tostring(events.payload_status_message_s),
payload_request_parent_s=tostring(events.payload_request_parent_s),
payload_request_show_deleted_b=tobool(events.payload_request_show_deleted_b),
resource_labels_role_name_s=tostring(events.resource_labels_role_name_s),
payload_serviceData__type_s=tostring(events.payload_serviceData__type_s),
resource_labels_project_id_s=tostring(events.resource_labels_project_id_s),
resource_labels_email_id_s=tostring(events.resource_labels_email_id_s),
resource_type_s=tostring(events.resource_type_s),
timestamp_t=todatetime(events.timestamp_t),
severity_s=tostring(events.severity_s),
insert_id_s=tostring(events.insert_id_s),
log_name_s=tostring(events.log_name_s),
payload_request_skip_visibility_check_b=tobool(events.payload_request_skip_visibility_check_b),
payload_response_group_title_s=tostring(events.payload_response_group_title_s),
payload_response_included_permissions_s=tostring(events.payload_response_included_permissions_s),
payload_response_group_name_s=tostring(events.payload_response_group_name_s),
payload_request_role_id_s=tostring(events.payload_request_role_id_s),
payload_request_role_description_s=tostring(events.payload_request_role_description_s),
payload_request_role_title_s=tostring(events.payload_request_role_title_s),
payload_request_role_included_permissions_s=tostring(events.payload_request_role_included_permissions_s),
payload_serviceData_permissionDelta_addedPermissions_s=tostring(events.payload_serviceData_permissionDelta_addedPermissions_s),
payload_response_title_s=tostring(events.payload_response_title_s),
payload_request_page_token_s=tostring(events.payload_request_page_token_s),
_TimeReceived=todatetime(now())
}

.alter table GCP_IAM_CL policy update @'[{"Source": "GCP_IAM_CLRaw", "Query": "GCP_IAM_CLExpand()", "IsEnabled": "True", "IsTransactional": true}]'
