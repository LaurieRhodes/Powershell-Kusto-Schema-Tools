// ============================================================================
// Azure Data Explorer KQL Script for GCPCloudRun - UPDATED VERSION
// ============================================================================
// Generated: 2025-09-17 07:24:35
// Table type: Microsoft
// Schema discovered using hybrid approach (Management API + getschema)
// Data type corrections applied: TenantId->guid, Double->real (empirical fixes)
// All columns including underscore columns included
// Original columns: 87, Final columns: 87
// ============================================================================

.create-merge table GCPCloudRunRaw (records:dynamic)

.alter-merge table GCPCloudRunRaw policy retention softdelete = 1d

.alter table GCPCloudRunRaw policy caching hot = 1h

// JSON mapping - choose appropriate option based on data structure
.create-or-alter table GCPCloudRunRaw ingestion json mapping 'GCPCloudRunRawMapping' '[{"column":"records","Properties":{"path":"$.records"}}]'
// Alternative for direct events: '[{"column":"records","Properties":{"path":"$"}}]'

.create-merge table GCPCloudRun(
TimeGenerated:datetime,
TenantId:guid,
PayloadRequestServiceMetadataCreationTimestamp:string,
PayloadRequestServiceMetadataSelfLink:string,
PayloadRequestServiceMetadataResourceVersion:string,
PayloadRequestServiceMetadataNameSpace:string,
PayloadRequestServiceMetadataName:string,
PayloadRequestDomainMappingStatus:string,
PayloadRequestDomainMappingMetadataAnnotations:string,
PayloadRequestDomainMappingMetadataNameSpace:string,
PayloadRequestDomainMappingMetadataName:string,
PayloadRequestDomainMappingSpec:string,
PayloadRequestDomainMappingKind:string,
PayloadRequestDomainMappingApiVersion:string,
PayloadRequestJobMetadataAnnotations:string,
PayloadRequestJobMetadataNameSpace:string,
PayloadRequestJobMetadataName:string,
PayloadRequestJobSpec:string,
PayloadRequestJobKind:string,
PayloadRequestServiceMetadataUID:string,
PayloadRequestServiceMetadataGeneration:string,
PayloadRequestServiceMetadatalabels:string,
PayloadRequestServiceMetadataAnnotations:string,
ResourceLabelsServiceName:string,
ResourceLabelsRevisionName:string,
ResourceLabelsConfigurationName:string,
GCPResourceType:string,
ResourceLabelsProjectId:string,
ResourceLabelslocation:string,
ResourceLabelsJobName:string,
PayloadRequestMetadataRequestAttributesReason:string,
PayloadRequestJobApiVersion:string,
PayloadRequestBuildpackBuildEnableAutomaticUpdates:string,
PayloadRequestStorageSourceGeneration:string,
PayloadRequestImageUri:string,
PayloadRequestServiceServiceURL:string,
PayloadRequestServiceReadyRevision:string,
PayloadRequestServiceLatestRevision:string,
PayloadRequestServiceTraffic:string,
PayloadRequestServiceObservedGeneration:string,
PayloadRequestServiceStatusConditions:string,
PayloadRequestBuildpackBuildBaseImage:string,
PayloadrequestMetadataCallerIp:string,
PayloadRequestResource:string,
PayloadResponseServiceMetadatalabels:string,
PayloadResourceLocationCurrentLocations:string,
PayloadrequestMetadatarequestAttributesTime:datetime,
PayloadrequestMetadatarequestAttributesAuth:string,
PayloadrequestMetadataDestinationAttributes:string,
PayloadrequestMetadatacallerSuppliedUserAgent:string,
PayloadRequestRegion:string,
PayloadRequestName:string,
PayloadRequestType:string,
PayloadMethodName:string,
PayloadAuthorizationInfo:dynamic,
PayloadAuthInfoPrincipalEmail:string,
PayloadType:string,
Severity:string,
ReceiveTimestamp:datetime,
LogName:string,
Labels:string,
InsertId:string,
PayloadResourceName:string,
PayloadServiceName:string,
PayloadAuthenticationInfoPrincipalSubject:string,
PayloadRequestLabelSelector:string,
PayloadResponseMetadataResourceVersion:string,
PayloadResponseMetadataGeneration:string,
PayloadResponseMetadataUID:string,
PayloadResponseMetadataCreationTimestamp:string,
PayloadResponseMetadataSelfLink:string,
PayloadResponseStatus:string,
PayloadResponseMetadataAnnotations:string,
PayloadResponseNameSpace:string,
PayloadRequestOptionsRequestedPolicyVersion:string,
PayloadResponseMetadataName:string,
PayloadResponseKind:string,
PayloadResponseApiVersion:string,
PayloadResponseType:string,
PayloadAuthenticationInfoServiceAccountKeyName:string,
PayloadRequestServiceSpec:string,
PayloadRequestServiceKind:string,
PayloadRequestServiceApiVersion:string,
PayloadRequestParent:string,
PayloadResponseSpec:string,
SourceSystem:string,
Type:string,
_TimeReceived:datetime)

.alter table GCPCloudRun policy caching hot = 1d

.create-or-alter function GCPCloudRunExpand() {
GCPCloudRunRaw
| mv-expand events = records
// Alternative for non-nested: | extend events = records
| project
TimeGenerated=todatetime(events.TimeGenerated),
TenantId=toguid(events.TenantId),
PayloadRequestServiceMetadataCreationTimestamp=tostring(events.PayloadRequestServiceMetadataCreationTimestamp),
PayloadRequestServiceMetadataSelfLink=tostring(events.PayloadRequestServiceMetadataSelfLink),
PayloadRequestServiceMetadataResourceVersion=tostring(events.PayloadRequestServiceMetadataResourceVersion),
PayloadRequestServiceMetadataNameSpace=tostring(events.PayloadRequestServiceMetadataNameSpace),
PayloadRequestServiceMetadataName=tostring(events.PayloadRequestServiceMetadataName),
PayloadRequestDomainMappingStatus=tostring(events.PayloadRequestDomainMappingStatus),
PayloadRequestDomainMappingMetadataAnnotations=tostring(events.PayloadRequestDomainMappingMetadataAnnotations),
PayloadRequestDomainMappingMetadataNameSpace=tostring(events.PayloadRequestDomainMappingMetadataNameSpace),
PayloadRequestDomainMappingMetadataName=tostring(events.PayloadRequestDomainMappingMetadataName),
PayloadRequestDomainMappingSpec=tostring(events.PayloadRequestDomainMappingSpec),
PayloadRequestDomainMappingKind=tostring(events.PayloadRequestDomainMappingKind),
PayloadRequestDomainMappingApiVersion=tostring(events.PayloadRequestDomainMappingApiVersion),
PayloadRequestJobMetadataAnnotations=tostring(events.PayloadRequestJobMetadataAnnotations),
PayloadRequestJobMetadataNameSpace=tostring(events.PayloadRequestJobMetadataNameSpace),
PayloadRequestJobMetadataName=tostring(events.PayloadRequestJobMetadataName),
PayloadRequestJobSpec=tostring(events.PayloadRequestJobSpec),
PayloadRequestJobKind=tostring(events.PayloadRequestJobKind),
PayloadRequestServiceMetadataUID=tostring(events.PayloadRequestServiceMetadataUID),
PayloadRequestServiceMetadataGeneration=tostring(events.PayloadRequestServiceMetadataGeneration),
PayloadRequestServiceMetadatalabels=tostring(events.PayloadRequestServiceMetadatalabels),
PayloadRequestServiceMetadataAnnotations=tostring(events.PayloadRequestServiceMetadataAnnotations),
ResourceLabelsServiceName=tostring(events.ResourceLabelsServiceName),
ResourceLabelsRevisionName=tostring(events.ResourceLabelsRevisionName),
ResourceLabelsConfigurationName=tostring(events.ResourceLabelsConfigurationName),
GCPResourceType=tostring(events.GCPResourceType),
ResourceLabelsProjectId=tostring(events.ResourceLabelsProjectId),
ResourceLabelslocation=tostring(events.ResourceLabelslocation),
ResourceLabelsJobName=tostring(events.ResourceLabelsJobName),
PayloadRequestMetadataRequestAttributesReason=tostring(events.PayloadRequestMetadataRequestAttributesReason),
PayloadRequestJobApiVersion=tostring(events.PayloadRequestJobApiVersion),
PayloadRequestBuildpackBuildEnableAutomaticUpdates=tostring(events.PayloadRequestBuildpackBuildEnableAutomaticUpdates),
PayloadRequestStorageSourceGeneration=tostring(events.PayloadRequestStorageSourceGeneration),
PayloadRequestImageUri=tostring(events.PayloadRequestImageUri),
PayloadRequestServiceServiceURL=tostring(events.PayloadRequestServiceServiceURL),
PayloadRequestServiceReadyRevision=tostring(events.PayloadRequestServiceReadyRevision),
PayloadRequestServiceLatestRevision=tostring(events.PayloadRequestServiceLatestRevision),
PayloadRequestServiceTraffic=tostring(events.PayloadRequestServiceTraffic),
PayloadRequestServiceObservedGeneration=tostring(events.PayloadRequestServiceObservedGeneration),
PayloadRequestServiceStatusConditions=tostring(events.PayloadRequestServiceStatusConditions),
PayloadRequestBuildpackBuildBaseImage=tostring(events.PayloadRequestBuildpackBuildBaseImage),
PayloadrequestMetadataCallerIp=tostring(events.PayloadrequestMetadataCallerIp),
PayloadRequestResource=tostring(events.PayloadRequestResource),
PayloadResponseServiceMetadatalabels=tostring(events.PayloadResponseServiceMetadatalabels),
PayloadResourceLocationCurrentLocations=tostring(events.PayloadResourceLocationCurrentLocations),
PayloadrequestMetadatarequestAttributesTime=todatetime(events.PayloadrequestMetadatarequestAttributesTime),
PayloadrequestMetadatarequestAttributesAuth=tostring(events.PayloadrequestMetadatarequestAttributesAuth),
PayloadrequestMetadataDestinationAttributes=tostring(events.PayloadrequestMetadataDestinationAttributes),
PayloadrequestMetadatacallerSuppliedUserAgent=tostring(events.PayloadrequestMetadatacallerSuppliedUserAgent),
PayloadRequestRegion=tostring(events.PayloadRequestRegion),
PayloadRequestName=tostring(events.PayloadRequestName),
PayloadRequestType=tostring(events.PayloadRequestType),
PayloadMethodName=tostring(events.PayloadMethodName),
PayloadAuthorizationInfo=todynamic(events.PayloadAuthorizationInfo),
PayloadAuthInfoPrincipalEmail=tostring(events.PayloadAuthInfoPrincipalEmail),
PayloadType=tostring(events.PayloadType),
Severity=tostring(events.Severity),
ReceiveTimestamp=todatetime(events.ReceiveTimestamp),
LogName=tostring(events.LogName),
Labels=tostring(events.Labels),
InsertId=tostring(events.InsertId),
PayloadResourceName=tostring(events.PayloadResourceName),
PayloadServiceName=tostring(events.PayloadServiceName),
PayloadAuthenticationInfoPrincipalSubject=tostring(events.PayloadAuthenticationInfoPrincipalSubject),
PayloadRequestLabelSelector=tostring(events.PayloadRequestLabelSelector),
PayloadResponseMetadataResourceVersion=tostring(events.PayloadResponseMetadataResourceVersion),
PayloadResponseMetadataGeneration=tostring(events.PayloadResponseMetadataGeneration),
PayloadResponseMetadataUID=tostring(events.PayloadResponseMetadataUID),
PayloadResponseMetadataCreationTimestamp=tostring(events.PayloadResponseMetadataCreationTimestamp),
PayloadResponseMetadataSelfLink=tostring(events.PayloadResponseMetadataSelfLink),
PayloadResponseStatus=tostring(events.PayloadResponseStatus),
PayloadResponseMetadataAnnotations=tostring(events.PayloadResponseMetadataAnnotations),
PayloadResponseNameSpace=tostring(events.PayloadResponseNameSpace),
PayloadRequestOptionsRequestedPolicyVersion=tostring(events.PayloadRequestOptionsRequestedPolicyVersion),
PayloadResponseMetadataName=tostring(events.PayloadResponseMetadataName),
PayloadResponseKind=tostring(events.PayloadResponseKind),
PayloadResponseApiVersion=tostring(events.PayloadResponseApiVersion),
PayloadResponseType=tostring(events.PayloadResponseType),
PayloadAuthenticationInfoServiceAccountKeyName=tostring(events.PayloadAuthenticationInfoServiceAccountKeyName),
PayloadRequestServiceSpec=tostring(events.PayloadRequestServiceSpec),
PayloadRequestServiceKind=tostring(events.PayloadRequestServiceKind),
PayloadRequestServiceApiVersion=tostring(events.PayloadRequestServiceApiVersion),
PayloadRequestParent=tostring(events.PayloadRequestParent),
PayloadResponseSpec=tostring(events.PayloadResponseSpec),
SourceSystem=tostring(events.SourceSystem),
Type=tostring(events.Type),
_TimeReceived=todatetime(now())
}

.alter table GCPCloudRun policy update @'[{"Source": "GCPCloudRunRaw", "Query": "GCPCloudRunExpand()", "IsEnabled": "True", "IsTransactional": true}]'
