# DCR from JSON

Data Collection Rule (DCR) Bicep templates generated from JSON schema exports. Each subdirectory contains Infrastructure as Code templates for ingesting data into specific Log Analytics tables with automated schema transformation.

## File Structure

Each subdirectory contains exactly three files:

### DCR Bicep Template (`dcr-{tablename}.bicep`)

- **Resource Type**: `Microsoft.Insights/dataCollectionRules@2022-06-01`
- **Stream Declaration**: Custom input stream with string/dynamic columns for flexible ingestion
- **Transform KQL**: Automated type conversion from input stream to target table schema
- **Role Assignment**: Service principal permissions for data ingestion
- **Outputs**: Immutable ID, DCR ID, and DCR name

### Parameters File (`dcr-{tablename}.parameters.json`)

- **Data Collection Endpoint**: DCE resource ID for secure ingestion
- **Workspace Configuration**: Target Log Analytics workspace settings
- **Service Principal**: Object ID for authentication and permissions
- **Location**: Deployment region (default: Australia East)

### Deployment Script (`deploy-{tablename}.ps1`)

- **PowerShell Automation**: Simplified deployment with timestamped naming
- **Parameter Validation**: Required resource group with optional parameters file
- **Verbose Output**: Detailed deployment progress and error reporting

## Generated Features

### Stream Processing

- **Input Stream**: Uses `Custom-{TableName}` stream with string/dynamic types for maximum compatibility
- **Transform KQL**: Automated type conversion (tostring, toint, toreal, todatetime, toguid, tolong)
- **Output Stream**: Matches target table schema with proper data types
- **Column Filtering**: Type and underscore columns filtered automatically

### Authentication & Permissions

- **Role Assignment**: Monitoring Metrics Publisher role (3913510d-42f4-4e42-8a64-420c390055eb)
- **Service Principal**: Automated permission assignment to DCR resource
- **Secure Ingestion**: Data Collection Endpoint integration for private networking

# 

## Deployment

### Prerequisites

- Data Collection Endpoint (DCE)
- Log Analytics Workspace
- Service Principal with appropriate permissions
- Az.Resources and Az.Monitor PowerShell modules

### Quick Deploy

```powershell
.\deploy-{tablename}.ps1 -ResourceGroupName "your-rg"
```

### Parameter Customization

Update parameters file with actual resource IDs:

```json
{
  "dataCollectionEndpointId": { "value": "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Insights/dataCollectionEndpoints/{dce}" },
  "workspaceResourceId": { "value": "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.OperationalInsights/workspaces/{workspace}" },
  "servicePrincipalObjectId": { "value": "{sp-object-id}" }
}
```

### Ingestion Endpoint

Data ingestion endpoint: `https://{dce-name}.{region}.ingest.monitor.azure.com/dataCollectionRules/{dcr-immutable-id}/streams/Custom-{TableName}`

## Source Generation

Generated by `json-to-bicep-dcr-export.ps1` from standardized JSON schema exports with automated output stream logic and KQL transformation.